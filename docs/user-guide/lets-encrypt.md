# Let's Encrypt configuration

This section explains how to deploy Træfik as a Docker service with Let's encrypt configuration.

## Prerequisites

1. You will need to install [docker-engine](https://docs.docker.com/engine/) (V1.13+)
2. You will need to install [docker-compose](https://docs.docker.com/compose/overview/) (v1.10+)
3. You will need to create a domain and rely it to your Docker Host (*træfik.io* in the example).
4. You will need to create the ${ACME_DIR]/acme.json file (and give it the correct access rights). This file will be mounted into your container and will contain the Let's Encrypt certificates :

```bash
touch ${ACME_DIR}/acme.json && \
chmod 600 ${ACME_DIR}/acme.json  # With ${ACME_DIR} the directory wich will contains the acme.json file on the Docker Host.
```

## Create the Træfik configuration file

Create the ${ACME_DIR}/traefik-acme.toml, with ${ACME_DIR} the directory wich contains the `traefik-acme.toml` file on the Docker Host. This file will be mounted on the Træfik container to configure the Træfik instance.

```toml
defaultEntryPoints = ["http", "https"]

[entryPoints]
  [entryPoints.http]
  address = ":80"
    [entryPoints.http.redirect]
        entryPoint = "https"
  [entryPoints.https]
  address = ":443"
    [entryPoints.https.tls]
          CertFile = "/etc/pki/tls/certs/mycert.crt"
          KeyFile = "/etc/pki/tls/private/mycert.key"


[acme]
email = "test@traefik.io"
storage = "/traefik-acme.json"
entryPoint = "https"
OnHostRule = true
caServer = "https://acme-staging.api.letsencrypt.org/directory"

[web]
  address = ":8080"

[docker]
endpoint = "unix:///var/run/docker.sock"
domain = "traefik.io"
watch = true
exposedbydefault = true
```

This configuration will allow initializing a Træfik instance with Let's Encrypt configuration :

* `email = "test@traefik.io"` : user email
* `storage = "/traefik-acme.json"`: file to store the acme configuration (can be a key value store entry in cluster mode)
* `entryPoint = "https"` : entrypoint which uses the Let's Encrypt certificates
* `OnHostRule = true` : only generate a new certificate for new (sub)domain
* `caServer = "https://acme-staging.api.letsencrypt.org/directory"` : CA root to use, `https://acme-staging.api.letsencrypt.org/directory` (has only to be used for test).

## Create a docker-compose file

Create the ${ACME_DIR}/docker-compose.yml file, with ${ACME_DIR} the directory wich contains the `docker-compose.yml` file on the Docker Host. This file describes the Træfik Docker service to create.

```yaml
version: "2"
services:
  traefik:
    image: containous/traefik:latest
    command: --configFile=/traefik-acme.toml
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "./acme.json:/acme.json:rw"
      - "./traefik-acme.toml:/traefik-acme.toml:ro"
    ports:
      - "443:443"
      - "80:80"
    expose:
      - "8080"
    labels:
      - "traefik.port=8080"
      - "traefik.backend=traefik-acme"
      - "traefik.frontend.rule=Host:acme.traefik.io"
      - "traefik.enable=true"
      - "traefik.docker.network=traefik_net"
    networks:
      - net
networks:
    net:

```

Let's explain this configuration:

- `ports`: we publish port `80` and `443` on the Docker Host.
- `volumes`: we mount the docker socket where Træfik is scheduled to be able to speak to the daemon, the Træfik configuration file and the Let's Encrypt storage file.
- `networks `: we attach the Træfik service (and thus the underlying container) to the `traefik_net` network.
- `labels`: we declare all the labels Træfik needs to expose itself and to expose the monitoring HMI :
    - `traefik.port` : the service port to contact
    - `traefik.backend` : the backend name
    - `traefik.frontend.rule` : the frontend rule

## Deploy Træfik

Let's deploy Træfik as a docker service.

```shell
docker-compose -p traefik -f ${ACME_DIR}/docker-compose.yml up -d # With ${ACME_DIR} the directory wich will contains the `docker-compose.yml` file.
```

## Test Træfik

In a web browser, go to the address `http://${MY_DNS}/` (with ${MY_DNS} the Træfik service subdomains, `acme.traefik.io` in the example). Træfik will redirect to `https://${MY_DNS}/dashboard/#` with a SSL certificate generated by Let's Encrypt.